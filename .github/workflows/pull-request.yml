name: Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '14'
      - name: Get npm cache directory
        id: npm-cache
        run: |
          echo "::set-output name=dir::$(npm config get cache)"
      - name: Cache for npm
        uses: actions/cache@v2
        with:
          path: ${{ steps.npm-cache.outputs.dir }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install packages
        run: npm ci
      - name: Build
        run: npm run build
  # FIXME
  # -----
  # auto-merge doesn't work due to the change described in the following blog:
  # https://github.blog/changelog/2021-02-19-github-actions-workflows-triggered-by-dependabot-prs-will-run-with-read-only-permissions/
  #
  # See also:
  # https://github.com/actions/checkout/issues/298
  #
  # auto-merge:
  #   if: github.actor == 'dependabot[bot]'
  #   needs:
  #     - build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/github-script@v2
  #       with:
  #         github-token: ${{secrets.GH_TOKEN}}
  #         script: |
  #           await github.pulls.createReview({
  #             owner: context.payload.repository.owner.login,
  #             repo: context.payload.repository.name,
  #             pull_number: context.payload.pull_request.number,
  #             event: 'APPROVE'
  #           })
  #           await github.pulls.merge({
  #             owner: context.payload.repository.owner.login,
  #             repo: context.payload.repository.name,
  #             pull_number: context.payload.pull_request.number
  #           })
